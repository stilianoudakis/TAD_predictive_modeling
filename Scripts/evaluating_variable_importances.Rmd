---
title: "Evaluating Variable Importances"
author: "Spiro Stilianoudakis"
date: "March 9, 2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Loading Libraries

```{r}
library(GenomicRanges)
library(caret)
library(data.table)
library(gbm)
library(randomForest)
library(glmnet)
library(pROC)
library(plyr)
library(dplyr)
library(ggplot2)
library(DMwR)
library(gridExtra)
library(pROC)
library(ROCR)
#library(leaps)
library(cluster)
library(ggpubr)
library(scales)
library(GGally)
library(VennDiagram)
library(network)
library(sna)
library(gtable)
library(grid)
library(magrittr) 
library(DT)
library(tidyverse)
library(reshape)
library(ROSE)
library(lattice)
library(corrplot)
library(cluster)
library(RColorBrewer)

```


## Variable Importance Heatmaps for models with distance type predictors (Ranks)

### SMOTE

```{r}
#GM12878 

rfimpvars_gm12878_10kb_SMOTE <- readRDS("Z:/TAD_data_analysis/GM12878/10kb/Ensemble/SMOTE/Distance/ENET/RF/rfimpvars.rds")
rfimpvars_gm12878_25kb_SMOTE <- readRDS("Z:/TAD_data_analysis/GM12878/25kb/Ensemble/SMOTE/Distance/ENET/RF/rfimpvars.rds")
rfimpvars_gm12878_50kb_SMOTE <- readRDS("Z:/TAD_data_analysis/GM12878/50kb/Ensemble/SMOTE/Distance/ENET/RF/rfimpvars.rds")
rfimpvars_gm12878_100kb_SMOTE <- readRDS("Z:/TAD_data_analysis/GM12878/100kb/Ensemble/SMOTE/Distance/ENET/RF/rfimpvars.rds")

rfimpvars_gm12878_10kb_SMOTE$Feature <- gsub(paste(c("`","_dist"),sep="", collapse="|"),"", rfimpvars_gm12878_10kb_SMOTE$Feature)
rfimpvars_gm12878_25kb_SMOTE$Feature <- gsub(paste(c("`","_dist"),sep="", collapse="|"),"", rfimpvars_gm12878_25kb_SMOTE$Feature)
rfimpvars_gm12878_50kb_SMOTE$Feature <- gsub(paste(c("`","_dist"),sep="", collapse="|"),"", rfimpvars_gm12878_50kb_SMOTE$Feature)
rfimpvars_gm12878_100kb_SMOTE$Feature <- gsub(paste(c("`","_dist"),sep="", collapse="|"),"", rfimpvars_gm12878_100kb_SMOTE$Feature)

unionannots <- union(rfimpvars_gm12878_10kb_SMOTE$Feature,
                      union(rfimpvars_gm12878_25kb_SMOTE$Feature,
                            union(rfimpvars_gm12878_50kb_SMOTE$Feature,rfimpvars_gm12878_100kb_SMOTE$Feature)))
unionannots <- sort(unionannots)

vim.gm12878.smote <- data.frame(Feature=unionannots)

vim.gm12878.smote <- left_join(left_join(left_join(left_join(vim.gm12878.smote,rfimpvars_gm12878_10kb_SMOTE, by="Feature"),
								rfimpvars_gm12878_25kb_SMOTE, by="Feature"),
								rfimpvars_gm12878_50kb_SMOTE, by="Feature"),
								rfimpvars_gm12878_100kb_SMOTE, by="Feature")
names(vim.gm12878.smote) <- c("Feature","Importance.10kb","Importance.25kb","Importance.50kb","Importance.100kb")
								
vim.gm12878.smote.ranks <- data.frame(Feature=vim.gm12878.smote$Feature,
									  Rank.10kb=rank(-vim.gm12878.smote$Importance.10kb, na.last = TRUE),
									  Rank.25kb=rank(-vim.gm12878.smote$Importance.25kb, na.last = TRUE),
									  Rank.50kb=rank(-vim.gm12878.smote$Importance.50kb, na.last = TRUE),
									  Rank.100kb=rank(-vim.gm12878.smote$Importance.100kb, na.last = TRUE))
									  

rankdata <- cbind(vim.gm12878.smote.ranks$Rank.10kb,
                  vim.gm12878.smote.ranks$Rank.25kb,
				  vim.gm12878.smote.ranks$Rank.50kb,
				  vim.gm12878.smote.ranks$Rank.100kb)
rownames(rankdata) <- vim.gm12878.smote.ranks$Feature
colnames(rankdata) <- c("10 kb", "25 kb", "50 kb", "100 kb")	 			  
rankdata <- rankdata[order(rankdata[,1], decreasing = FALSE),]
rankdata <- rankdata[1:20,]
				  
#my_palette <- rev(colorRampPalette(brewer.pal(11, "RdBu"))(100)) 
my_palette <- colorRampPalette(c("red", "pink", "white"))(nrow(rankdata))
heatmap.2(t(rankdata),
          #cellnote = ,  # same data set for cell labels
          #main = "", # heat map title
          notecol="black",      # change font color of cell labels to black
          density.info="none",  # turns off density plot inside color legend
          trace="none",         # turns off trace lines inside the heat map
          margins=c(12,8),     # widens margins around plot
          col=my_palette,       # use on color palette defined earlier
          na.color = "gray",
          #breaks=col_breaks,    # enable color transition at specified limits
          key=FALSE,
          #keysize = 1.5,
          #key.title = "Elastic-Net Coefficient",
          dendrogram="column",     # only draw a row dendrogram,
          Rowv = FALSE,
          Colv = TRUE,
          cexRow=1.5,
          cexCol=1.5,
          #labRow = FALSE,
          #lmat=rbind( c(0, 3), c(2,1), c(0,4) ), 
          #lhei=c(.5,6,0),
          sepwidth=c(0.001,0.001),
          sepcolor="black",
          rowsep=1:4,
          colsep=0:nrow(rankdata)) 


#K562

rfimpvars_K562_10kb_SMOTE <- readRDS("Z:/TAD_data_analysis/K562/10kb/Ensemble/SMOTE/Distance/ENET/RF/rfimpvars.rds")
rfimpvars_K562_25kb_SMOTE <- readRDS("Z:/TAD_data_analysis/K562/25kb/Ensemble/SMOTE/Distance/ENET/RF/rfimpvars.rds")
rfimpvars_K562_50kb_SMOTE <- readRDS("Z:/TAD_data_analysis/K562/50kb/Ensemble/SMOTE/Distance/ENET/RF/rfimpvars.rds")
rfimpvars_K562_100kb_SMOTE <- readRDS("Z:/TAD_data_analysis/K562/100kb/Ensemble/SMOTE/Distance/ENET/RF/rfimpvars.rds")

rfimpvars_K562_10kb_SMOTE$Feature <- gsub(paste(c("`","_dist"),sep="", collapse="|"),"", rfimpvars_K562_10kb_SMOTE$Feature)
rfimpvars_K562_25kb_SMOTE$Feature <- gsub(paste(c("`","_dist"),sep="", collapse="|"),"", rfimpvars_K562_25kb_SMOTE$Feature)
rfimpvars_K562_50kb_SMOTE$Feature <- gsub(paste(c("`","_dist"),sep="", collapse="|"),"", rfimpvars_K562_50kb_SMOTE$Feature)
rfimpvars_K562_100kb_SMOTE$Feature <- gsub(paste(c("`","_dist"),sep="", collapse="|"),"", rfimpvars_K562_100kb_SMOTE$Feature)

unionannots <- union(rfimpvars_K562_10kb_SMOTE$Feature,
                      union(rfimpvars_K562_25kb_SMOTE$Feature,
                            union(rfimpvars_K562_50kb_SMOTE$Feature,rfimpvars_K562_100kb_SMOTE$Feature)))
unionannots <- sort(unionannots)

vim.K562.smote <- data.frame(Feature=unionannots)

vim.K562.smote <- left_join(left_join(left_join(left_join(vim.K562.smote,rfimpvars_K562_10kb_SMOTE, by="Feature"),
								rfimpvars_K562_25kb_SMOTE, by="Feature"),
								rfimpvars_K562_50kb_SMOTE, by="Feature"),
								rfimpvars_K562_100kb_SMOTE, by="Feature")
names(vim.K562.smote) <- c("Feature","Importance.10kb","Importance.25kb","Importance.50kb","Importance.100kb")
								
vim.K562.smote.ranks <- data.frame(Feature=vim.K562.smote$Feature,
									  Rank.10kb=rank(-vim.K562.smote$Importance.10kb, na.last = TRUE),
									  Rank.25kb=rank(-vim.K562.smote$Importance.25kb, na.last = TRUE),
									  Rank.50kb=rank(-vim.K562.smote$Importance.50kb, na.last = TRUE),
									  Rank.100kb=rank(-vim.K562.smote$Importance.100kb, na.last = TRUE))
									  

rankdata <- cbind(vim.K562.smote.ranks$Rank.10kb,
                  vim.K562.smote.ranks$Rank.25kb,
				  vim.K562.smote.ranks$Rank.50kb,
				  vim.K562.smote.ranks$Rank.100kb)
rownames(rankdata) <- vim.K562.smote.ranks$Feature
colnames(rankdata) <- c("10 kb", "25 kb", "50 kb", "100 kb")
rankdata <- rankdata[order(rankdata[,1], decreasing = FALSE),]
rankdata <- rankdata[1:20,]
				  
#my_palette <- rev(colorRampPalette(brewer.pal(11, "RdBu"))(100)) 
my_palette <- colorRampPalette(c("red", "white"))(nrow(rankdata))
heatmap.2(t(rankdata),
          #cellnote = ,  # same data set for cell labels
          #main = "", # heat map title
          notecol="black",      # change font color of cell labels to black
          density.info="none",  # turns off density plot inside color legend
          trace="none",         # turns off trace lines inside the heat map
          margins=c(12,8),     # widens margins around plot
          col=my_palette,       # use on color palette defined earlier
          na.color = "gray",
          #breaks=col_breaks,    # enable color transition at specified limits
          key=FALSE,
          #key.title = "Elastic-Net\nCoefficient",
          #keysize = 2,
          dendrogram="both",     # only draw a row dendrogram,
          Rowv = TRUE,
          Colv = TRUE,
          cexRow=1.5,
          cexCol=0.5,
          #labRow = FALSE,
          #lmat=rbind( c(0, 3), c(2,1), c(0,4) ), 
          #lhei=c(.5,6,0),
          sepwidth=c(0.001,0.001),
          sepcolor="black",
          rowsep=1:4,
          colsep=0:nrow(rankdata)) 
```

## Average Variable Importances Heatmaps for models with distance type predictors (Ranks)

```{r}
#gm12878 
##average then rank
vim.gm12878.smote[is.na(vim.gm12878.smote)] <- 0

vim.gm12878.smote.ave.rank <- data.frame(Feature=vim.gm12878.smote$Feature,
                                    AveImp=rowMeans(vim.gm12878.smote[,-1]))
vim.gm12878.smote.ave.rank$Rank <- rank(-vim.gm12878.smote.ave.rank$AveImp, na.last = TRUE)
vim.gm12878.smote.ave.rank <- vim.gm12878.smote.ave.rank[order(vim.gm12878.smote.ave.rank$Rank, decreasing = FALSE),]
rankdata.a.r <- cbind(vim.gm12878.smote.ave.rank$Rank,vim.gm12878.smote.ave.rank$Rank)
rankdata.a.r <- rankdata.a.r[1:20,]
rownames(rankdata.a.r) <- vim.gm12878.smote.ave.rank$Feature[1:20]

#my_palette <- colorRampPalette(c("red", "white"))(100)
my_palette_rank <- colorRampPalette(c("red", "white"))(nrow(rankdata.a.r))
heatmap.2(t(rankdata.a.r),
          #cellnote = ,  # same data set for cell labels
          #main = "", # heat map title
          labRow = "",
          labCol = rownames(rankdata.a.r),
          notecol="black",      # change font color of cell labels to black
          density.info="none",  # turns off density plot inside color legend
          trace="none",         # turns off trace lines inside the heat map
          margins=c(12,8),     # widens margins around plot
          col=my_palette_rank,       # use on color palette defined earlier
          na.color = "gray",
          #breaks=col_breaks,    # enable color transition at specified limits
          key=FALSE,
          #key.title = "Elastic-Net\nCoefficient",
          #keysize = 2,
          dendrogram="none",     # only draw a row dendrogram,
          Rowv = NA,
          Colv = NA,
          cexRow=1.5,
          cexCol=1.5,
          #lmat=rbind( c(0, 3), c(2,1), c(0,4) ), 
          #lhei=c(.5,6,0),
          #lwid=c(.5,6,0),
          sepwidth=c(0.001,0.001),
          sepcolor="black",
          rowsep=c(0,2),
          colsep=0:nrow(rankdata.a.r)
          ) 

##rank then average
vim.gm12878.smote.rank.ave <- cbind(Rank.10kb=rank(-vim.gm12878.smote$Importance.10kb, na.last = TRUE),
                                    Rank.25kb=rank(-vim.gm12878.smote$Importance.25kb, na.last = TRUE),
                                    Rank.50kb=rank(-vim.gm12878.smote$Importance.50kb, na.last = TRUE),
                                    Rank.100kb=rank(-vim.gm12878.smote$Importance.100kb, na.last = TRUE))
rownames(vim.gm12878.smote.rank.ave) <- vim.gm12878.smote$Feature
rankdata.r.a <- rowMeans(vim.gm12878.smote.rank.ave)
rankdata.r.a <- rankdata.r.a[order(rankdata.r.a, decreasing = FALSE)]
rankdata.r.a <- rankdata.r.a[1:20]
rankdata.r.a <- cbind(rankdata.r.a,rankdata.r.a)
heatmap.2(t(rankdata.r.a),
          #cellnote = ,  # same data set for cell labels
          #main = "", # heat map title
          labRow = "",
          labCol = rownames(rankdata.r.a),
          notecol="black",      # change font color of cell labels to black
          density.info="none",  # turns off density plot inside color legend
          trace="none",         # turns off trace lines inside the heat map
          margins=c(12,8),     # widens margins around plot
          col=my_palette_rank,       # use on color palette defined earlier
          na.color = "gray",
          #breaks=col_breaks,    # enable color transition at specified limits
          key=FALSE,
          #key.title = "Elastic-Net\nCoefficient",
          #keysize = 2,
          dendrogram="none",     # only draw a row dendrogram,
          Rowv = NA,
          Colv = NA,
          cexRow=1.5,
          cexCol=1.5,
          #lmat=rbind( c(0, 3), c(2,1), c(0,4) ), 
          #lhei=c(.5,6,0),
          #lwid=c(.5,6,0),
          sepwidth=c(0.001,0.001),
          sepcolor="black",
          rowsep=c(0,2),
          colsep=0:nrow(rankdata.r.a)
          ) 


```


## ICC

```{r}
vim.gm12878.smote[is.na(vim.gm12878.smote)] <- 0
icc(vim.gm12878.smote, model = "twoway", type = "agreement")

```


#Variable Importance Heatmaps (actual importance values)

## SMOTE; distance types

### GM12878

```{r}
rfimpvars_gm12878_10kb_SMOTE <- readRDS("Z:/TAD_data_analysis/GM12878/10kb/Ensemble/SMOTE/Distance/ENET/RF/rfimpvars.rds")
rfimpvars_gm12878_25kb_SMOTE <- readRDS("Z:/TAD_data_analysis/GM12878/25kb/Ensemble/SMOTE/Distance/ENET/RF/rfimpvars.rds")
rfimpvars_gm12878_50kb_SMOTE <- readRDS("Z:/TAD_data_analysis/GM12878/50kb/Ensemble/SMOTE/Distance/ENET/RF/rfimpvars.rds")
rfimpvars_gm12878_100kb_SMOTE <- readRDS("Z:/TAD_data_analysis/GM12878/100kb/Ensemble/SMOTE/Distance/ENET/RF/rfimpvars.rds")

rfimpvars_gm12878_10kb_SMOTE$Feature <- gsub(paste(c("`","_dist"),sep="", collapse="|"),"", rfimpvars_gm12878_10kb_SMOTE$Feature)
rfimpvars_gm12878_25kb_SMOTE$Feature <- gsub(paste(c("`","_dist"),sep="", collapse="|"),"", rfimpvars_gm12878_25kb_SMOTE$Feature)
rfimpvars_gm12878_50kb_SMOTE$Feature <- gsub(paste(c("`","_dist"),sep="", collapse="|"),"", rfimpvars_gm12878_50kb_SMOTE$Feature)
rfimpvars_gm12878_100kb_SMOTE$Feature <- gsub(paste(c("`","_dist"),sep="", collapse="|"),"", rfimpvars_gm12878_100kb_SMOTE$Feature)

unionannots <- union(rfimpvars_gm12878_10kb_SMOTE$Feature,
                     union(rfimpvars_gm12878_25kb_SMOTE$Feature,
                           union(rfimpvars_gm12878_50kb_SMOTE$Feature,rfimpvars_gm12878_100kb_SMOTE$Feature)))
unionannots <- sort(unionannots)

vim.gm12878.smote <- data.frame(Feature=unionannots)

vim.gm12878.smote <- left_join(left_join(left_join(left_join(vim.gm12878.smote,rfimpvars_gm12878_10kb_SMOTE, by="Feature"),
                                                   rfimpvars_gm12878_25kb_SMOTE, by="Feature"),
                                         rfimpvars_gm12878_50kb_SMOTE, by="Feature"),
                               rfimpvars_gm12878_100kb_SMOTE, by="Feature")
names(vim.gm12878.smote) <- c("Feature","Importance.10kb","Importance.25kb","Importance.50kb","Importance.100kb")

vim.gm12878.smote <- vim.gm12878.smote[order(vim.gm12878.smote$Importance.10kb, decreasing = TRUE),]

vim.gm12878.smote.melt <- melt(vim.gm12878.smote)
vim.gm12878.smote.melt$Feature <- factor(vim.gm12878.smote.melt$Feature, levels = vim.gm12878.smote$Feature)

p.vim.gm12878 <- ggplot(vim.gm12878.smote.melt, aes(variable, 
                                                    ordered(Feature, levels=rev(unique(Feature))))) + 
  geom_tile(aes(fill = value), colour = "white") + 
  xlab("Resolution") +
  ylab("Genomic Annotation") +
  scale_fill_gradient2(low = "white",
                      mid = "pink",
                      midpoint = 50,
                      high = muted("red"),
                      na.value = "grey50",
                      name="Predictive\nImportance") +
  scale_x_discrete(labels=c("10 kb", "25 kb", "50 kb", "100 kb"))+
  theme_bw() +
  theme(axis.text.x = element_text(size=15,
                                   angle = 45,
                                   hjust = 1),
        axis.text.y = element_text(size = 5),
        axis.title.x = element_text(size = 20),
        axis.title.y = element_text(size = 20),
        legend.text=element_text(size=15),
        legend.title=element_text(size=20))
```


### K562

```{r}
rfimpvars_K562_10kb_SMOTE <- readRDS("Z:/TAD_data_analysis/K562/10kb/Ensemble/SMOTE/Distance/ENET/RF/rfimpvars.rds")
rfimpvars_K562_25kb_SMOTE <- readRDS("Z:/TAD_data_analysis/K562/25kb/Ensemble/SMOTE/Distance/ENET/RF/rfimpvars.rds")
rfimpvars_K562_50kb_SMOTE <- readRDS("Z:/TAD_data_analysis/K562/50kb/Ensemble/SMOTE/Distance/ENET/RF/rfimpvars.rds")
rfimpvars_K562_100kb_SMOTE <- readRDS("Z:/TAD_data_analysis/K562/100kb/Ensemble/SMOTE/Distance/ENET/RF/rfimpvars.rds")

rfimpvars_K562_10kb_SMOTE$Feature <- gsub(paste(c("`","_dist"),sep="", collapse="|"),"", rfimpvars_K562_10kb_SMOTE$Feature)
rfimpvars_K562_25kb_SMOTE$Feature <- gsub(paste(c("`","_dist"),sep="", collapse="|"),"", rfimpvars_K562_25kb_SMOTE$Feature)
rfimpvars_K562_50kb_SMOTE$Feature <- gsub(paste(c("`","_dist"),sep="", collapse="|"),"", rfimpvars_K562_50kb_SMOTE$Feature)
rfimpvars_K562_100kb_SMOTE$Feature <- gsub(paste(c("`","_dist"),sep="", collapse="|"),"", rfimpvars_K562_100kb_SMOTE$Feature)

unionannots <- union(rfimpvars_K562_10kb_SMOTE$Feature,
                     union(rfimpvars_K562_25kb_SMOTE$Feature,
                           union(rfimpvars_K562_50kb_SMOTE$Feature,rfimpvars_K562_100kb_SMOTE$Feature)))
unionannots <- sort(unionannots)

vim.K562.smote <- data.frame(Feature=unionannots)

vim.K562.smote <- left_join(left_join(left_join(left_join(vim.K562.smote,rfimpvars_K562_10kb_SMOTE, by="Feature"),
                                                   rfimpvars_K562_25kb_SMOTE, by="Feature"),
                                         rfimpvars_K562_50kb_SMOTE, by="Feature"),
                               rfimpvars_K562_100kb_SMOTE, by="Feature")
names(vim.K562.smote) <- c("Feature","Importance.10kb","Importance.25kb","Importance.50kb","Importance.100kb")

vim.K562.smote <- vim.K562.smote[order(vim.K562.smote$Importance.10kb, decreasing = TRUE),]

vim.K562.smote.melt <- melt(vim.K562.smote)
vim.K562.smote.melt$Feature <- factor(vim.K562.smote.melt$Feature, levels = vim.K562.smote$Feature)

p.vim.K562 <- ggplot(vim.K562.smote.melt, aes(variable, 
                                                    ordered(Feature, levels=rev(unique(Feature))))) + 
  geom_tile(aes(fill = value), colour = "white") + 
  xlab("Resolution") +
  ylab("Genomic Annotation") +
  scale_fill_gradient2(low = "white",
                      mid = "pink",
                      midpoint = 50,
                      high = muted("red"),
                      na.value = "grey50",
                      name="Predictive\nImportance") +
  scale_x_discrete(labels=c("10 kb", "25 kb", "50 kb", "100 kb"))+
  theme_bw() +
  theme(axis.text.x = element_text(size=15,
                                   angle = 45,
                                   hjust = 1),
        axis.text.y = element_text(size = 5),
        axis.title.x = element_text(size = 20),
        axis.title.y = element_text(size = 20),
        legend.text=element_text(size=15),
        legend.title=element_text(size=20))
```

