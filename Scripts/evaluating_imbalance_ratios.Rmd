---
title: "Evaluating Class Imbalance"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Loading Libraries

```{r}
library(GenomicRanges)
library(caret)
library(data.table)
library(gbm)
library(randomForest)
library(glmnet)
library(pROC)
library(plyr)
library(dplyr)
library(ggplot2)
library(DMwR)
library(gridExtra)
library(pROC)
library(ROCR)
#library(leaps)
library(cluster)
library(ggpubr)
library(scales)
library(GGally)
library(VennDiagram)
library(network)
library(sna)
library(gtable)
library(grid)
library(magrittr) 
library(DT)
library(tidyverse)
library(reshape)
library(ROSE)
library(lattice)

```

#Evaluating Imbalance Ratios

<!--
##GM12878
###10kb

```{r}
IR_gm12878_10kb <- numeric(22)

#reading in whole genome data
whole_genome_dat <- readRDS("Z:/TAD_data_analysis/GM12878/10kb/training_testing/gm12878_10kb.rds")
#reading in bin data on the whole genome that contains chromosome information
binslist_dat <- readRDS("Z:/TAD_data_analysis/GM12878/10kb/training_testing/binslist10.rds")
  

for(i in 1:22){
  #reducing the whole genome data to only specific chromosome
	reduce_chr <- paste0("chr", i)
	chr_specific_dat <- whole_genome_dat[which(as.character(seqnames(binslist_dat))==reduce_chr),]
	
  IR_gm12878_10kb[i] <- length(chr_specific_dat$y[which(chr_specific_dat$y=="Yes")])/length(chr_specific_dat$y[which(chr_specific_dat$y=="No")])
}


```		

###25kb

```{r}
IR_gm12878_25kb <- numeric(22)

#reading in whole genome data
whole_genome_dat <- readRDS("Z:/TAD_data_analysis/GM12878/25kb/training_testing/gm12878_25kb.rds")
#reading in bin data on the whole genome that contains chromosome information
binslist_dat <- readRDS("Z:/TAD_data_analysis/GM12878/25kb/training_testing/binslist25.rds")
  

for(i in 1:22){
  #reducing the whole genome data to only specific chromosome
	reduce_chr <- paste0("chr", i)
	chr_specific_dat <- whole_genome_dat[which(as.character(seqnames(binslist_dat))==reduce_chr),]
	
  IR_gm12878_25kb[i] <- length(chr_specific_dat$y[which(chr_specific_dat$y=="Yes")])/length(chr_specific_dat$y[which(chr_specific_dat$y=="No")])
}


```		

###50kb

```{r}
IR_gm12878_50kb <- numeric(22)

#reading in whole genome data
whole_genome_dat <- readRDS("Z:/TAD_data_analysis/GM12878/50kb/training_testing/gm12878_50kb.rds")
#reading in bin data on the whole genome that contains chromosome information
binslist_dat <- readRDS("Z:/TAD_data_analysis/GM12878/50kb/training_testing/binslist50.rds")
  

for(i in 1:22){
  #reducing the whole genome data to only specific chromosome
	reduce_chr <- paste0("chr", i)
	chr_specific_dat <- whole_genome_dat[which(as.character(seqnames(binslist_dat))==reduce_chr),]
	
  IR_gm12878_50kb[i] <- length(chr_specific_dat$y[which(chr_specific_dat$y=="Yes")])/length(chr_specific_dat$y[which(chr_specific_dat$y=="No")])
}


```		

###100kb

```{r}
IR_gm12878_100kb <- numeric(22)

#reading in whole genome data
whole_genome_dat <- readRDS("Z:/TAD_data_analysis/GM12878/100kb/training_testing/gm12878_100kb.rds")
#reading in bin data on the whole genome that contains chromosome information
binslist_dat <- readRDS("Z:/TAD_data_analysis/GM12878/100kb/training_testing/binslist100.rds")
  

for(i in 1:22){
  #reducing the whole genome data to only specific chromosome
	reduce_chr <- paste0("chr", i)
	chr_specific_dat <- whole_genome_dat[which(as.character(seqnames(binslist_dat))==reduce_chr),]
	
  IR_gm12878_100kb[i] <- length(chr_specific_dat$y[which(chr_specific_dat$y=="Yes")])/length(chr_specific_dat$y[which(chr_specific_dat$y=="No")])
}


```		
	

##K562
###10kb

```{r}
IR_K562_10kb <- numeric(22)

#reading in whole genome data
whole_genome_dat <- readRDS("Z:/TAD_data_analysis/K562/10kb/training_testing/K562_10kb.rds")
#reading in bin data on the whole genome that contains chromosome information
binslist_dat <- readRDS("Z:/TAD_data_analysis/K562/10kb/training_testing/binslist10.rds")
  

for(i in 1:22){
  #reducing the whole genome data to only specific chromosome
	reduce_chr <- paste0("chr", i)
	chr_specific_dat <- whole_genome_dat[which(as.character(seqnames(binslist_dat))==reduce_chr),]
	
  IR_K562_10kb[i] <- length(chr_specific_dat$y[which(chr_specific_dat$y=="Yes")])/length(chr_specific_dat$y[which(chr_specific_dat$y=="No")])
}


```		

###25kb

```{r}
IR_K562_25kb <- numeric(22)

#reading in whole genome data
whole_genome_dat <- readRDS("Z:/TAD_data_analysis/K562/25kb/training_testing/K562_25kb.rds")
#reading in bin data on the whole genome that contains chromosome information
binslist_dat <- readRDS("Z:/TAD_data_analysis/K562/25kb/training_testing/binslist25.rds")
  

for(i in 1:22){
  #reducing the whole genome data to only specific chromosome
	reduce_chr <- paste0("chr", i)
	chr_specific_dat <- whole_genome_dat[which(as.character(seqnames(binslist_dat))==reduce_chr),]
	
  IR_K562_25kb[i] <- length(chr_specific_dat$y[which(chr_specific_dat$y=="Yes")])/length(chr_specific_dat$y[which(chr_specific_dat$y=="No")])
}


```		

###50kb

```{r}
IR_K562_50kb <- numeric(22)

#reading in whole genome data
whole_genome_dat <- readRDS("Z:/TAD_data_analysis/K562/50kb/training_testing/K562_50kb.rds")
#reading in bin data on the whole genome that contains chromosome information
binslist_dat <- readRDS("Z:/TAD_data_analysis/K562/50kb/training_testing/binslist50.rds")
  

for(i in 1:22){
  #reducing the whole genome data to only specific chromosome
	reduce_chr <- paste0("chr", i)
	chr_specific_dat <- whole_genome_dat[which(as.character(seqnames(binslist_dat))==reduce_chr),]
	
  IR_K562_50kb[i] <- length(chr_specific_dat$y[which(chr_specific_dat$y=="Yes")])/length(chr_specific_dat$y[which(chr_specific_dat$y=="No")])
}


```		

###100kb

```{r}
IR_K562_100kb <- numeric(22)

#reading in whole genome data
whole_genome_dat <- readRDS("Z:/TAD_data_analysis/K562/100kb/training_testing/K562_100kb.rds")
#reading in bin data on the whole genome that contains chromosome information
binslist_dat <- readRDS("Z:/TAD_data_analysis/K562/100kb/training_testing/binslist100.rds")
  

for(i in 1:22){
  #reducing the whole genome data to only specific chromosome
	reduce_chr <- paste0("chr", i)
	chr_specific_dat <- whole_genome_dat[which(as.character(seqnames(binslist_dat))==reduce_chr),]
	
  IR_K562_100kb[i] <- length(chr_specific_dat$y[which(chr_specific_dat$y=="Yes")])/length(chr_specific_dat$y[which(chr_specific_dat$y=="No")])
}


```		
-->


<!--	
# Combined Plots

```{r}
irtab <- data.frame(IR = c(IR_gm12878_10kb,
                                 IR_gm12878_25kb,
                                 IR_gm12878_50kb,
                                 IR_gm12878_100kb,
                                 IR_K562_10kb,
                                 IR_K562_25kb,
                                 IR_K562_50kb,
                                 IR_K562_100kb),
                          CL = c(rep("GM12878", 22*4), rep("K562", 22*4)),
                          Resolution = rep(c("10 kb", "25 kb", "50 kb", "100 kb"), 2),
                          Chromosome = rep(paste0("CHR",1:22),4)
                          )

irtab$CL <- factor(irtab$CL, levels=c("GM12878", "K562"))
irtab$Resolution <- factor(irtab$Resolution, levels=c("10 kb", "25 kb", "50 kb", "100 kb"))
irtab$Chromosome <- factor(irtab$Chromosome, levels=paste0("CHR",1:22))

irtab <- irtab[-which(irtab$Chromosome=="CHR9"),]

ggplot(irtab, aes(x = Resolution, y = IR, fill = Resolution, color = Resolution)) +
  geom_boxplot(#fill = fill, 
               #colour = line,
               outlier.colour = "black") +
  facet_grid(~ CL) +
  guides(fill=FALSE, color=FALSE) +
  xlab("Resolution") +
  ylab("Imbalance Ratio") +
  theme_minimal() +
  theme_bw() +
  theme(axis.text.x = element_text(size=15,
                                   angle = 45, 
                                   #margin = ggplot2::margin(t = 35),
                                   hjust = 1),
        axis.text.y = element_text(size = 15),
        axis.title.x = element_text(size = 20),
        axis.title.y = element_text(size = 20),
        legend.text=element_text(size=15),
        legend.title=element_text(size=20),
        strip.text.x = element_text(size = 15))
  
  
```
-->

# Combined Tables

```{r}
cl.per.chr <- character()
res.per.chr <- character()
chr.per.chr <- character()
bins.per.chr <- numeric()
bounds.per.chr <- numeric()
ir.per.chr <- numeric()
tads.per.chr <- numeric()

chrs <- paste0("chr", c(1:8,10:22))
for(i in c("GM12878","K562")){
  for(j in c("10kb", "25kb","50kb","100kb")){
    for(k in 1:length(chrs)){
      binslist_dat_center <- readRDS(paste0("Z:/TAD_data_analysis/",
                                            i,
                                            "/",
                                            j,
                                            "/training_testing/binslist",
                                            gsub("kb","",j),
                                            "_center.rds"))
      
      tad_dat <- read.table(paste0("Z:/TAD_data_analysis/GSE63525_data/arrowhead_output/",
                                            i,
                                            "/",
                                            paste0(i,"_domain_data_", gsub("kb", "000", j), ".b.txt")))
      
      cl.per.chr <- rbind(cl.per.chr, i)
      res.per.chr <- rbind(res.per.chr, j)
      chr.per.chr <- rbind(chr.per.chr, chrs[k])
      
      bins.per.chr <- rbind(bins.per.chr, length(binslist_dat_center[seqnames(binslist_dat_center)==chrs[k]]))
      
      bounds.per.chr <- rbind(bounds.per.chr, table(mcols(binslist_dat_center[seqnames(binslist_dat_center)==chrs[k]])$y)[2])
      
      ir.per.chr <- rbind(ir.per.chr, table(mcols(binslist_dat_center[seqnames(binslist_dat_center)==chrs[k]])$y)[1]/table(mcols(binslist_dat_center[seqnames(binslist_dat_center)==chrs[k]])$y)[2])
      
      tads.per.chr <- rbind(tads.per.chr, dim(tad_dat[which(tad_dat$V1==k),])[1])
      
    }
  }
}

irtab <- cbind.data.frame(cl.per.chr,
                          res.per.chr,
                          chr.per.chr,
                          bins.per.chr,
                          tads.per.chr,
                          bounds.per.chr,
                          ir.per.chr)
colnames(irtab) <- c("cl","res","chr","bins","tads","bounds","ir")
irtab$res <- factor(irtab$res, levels=c("10kb","25kb","50kb","100kb"))

irtab_summ <- irtab %>%
  group_by(cl, res) %>%
  dplyr::summarise(AveBins = mean(bins, na.rm = TRUE),
            AveBinsSD = sd(bins, na.rm = TRUE),
            AveTADs = mean(tads, na.rm = TRUE),
            AveTADsSD = sd(tads, na.rm = TRUE),
            AveBounds = mean(bounds, na.rm = TRUE),
            AveBoundsSD = sd(bounds, na.rm = TRUE),
            AveIR = mean(ir, na.rm = TRUE),
            AveIRSD = sd(ir, na.rm = TRUE))

irtab_summ_med <- irtab %>%
  group_by(cl, res) %>%
  dplyr::summarise(MedBins = median(bins, na.rm = TRUE),
            MedBinsIQR = IQR(bins, na.rm = TRUE),
            MedTADs = median(tads, na.rm = TRUE),
            MedTADsIQR = IQR(tads, na.rm = TRUE),
            MedBounds = median(bounds, na.rm = TRUE),
            MedBoundsIQR = IQR(bounds, na.rm = TRUE),
            MedIR = median(ir, na.rm = TRUE),
            MedIRIQR = IQR(ir, na.rm = TRUE))

bounds_df <-irtab %>%
  group_by(cl, res) %>%
  dplyr::summarise(TotBounds = sum(bounds, na.rm = TRUE))
```

# ICC

## GM12878

### Number of genomic bins

```{r}
gbins <- reshape(irtab[which(irtab$cl=="GM12878"),c(2,3,4)], idvar = "chr", timevar = "res", direction = "wide")
icc(gbins[,-1], model="twoway")
```

### Number of TADs

```{r}
tads <- reshape(irtab[which(irtab$cl=="GM12878"),c(2,3,5)], idvar = "chr", timevar = "res", direction = "wide")
icc(tads[,-1], model="twoway")
```

### Number of boundaries

```{r}
bounds <- reshape(irtab[which(irtab$cl=="GM12878"),c(2,3,6)], idvar = "chr", timevar = "res", direction = "wide")
icc(bounds[,-1], model="twoway")
```

### IR

```{r}
imbratio <- reshape(irtab[which(irtab$cl=="GM12878"),c(2,3,7)], idvar = "chr", timevar = "res", direction = "wide")
icc(imbratio[,-1], model="twoway")
```


## K562

### Number of genomic bins

```{r}
gbins <- reshape(irtab[which(irtab$cl=="K562"),c(2,3,4)], idvar = "chr", timevar = "res", direction = "wide")
icc(gbins[,-1], model="twoway")
```

### Number of TADs

```{r}
tads <- reshape(irtab[which(irtab$cl=="K562"),c(2,3,5)], idvar = "chr", timevar = "res", direction = "wide")
icc(tads[,-1], model="twoway")
```

### Number of boundaries

```{r}
bounds <- reshape(irtab[which(irtab$cl=="K562"),c(2,3,6)], idvar = "chr", timevar = "res", direction = "wide")
icc(bounds[,-1], model="twoway")
```

### IR

```{r}
imbratio <- reshape(irtab[which(irtab$cl=="K562"),c(2,3,7)], idvar = "chr", timevar = "res", direction = "wide")
icc(imbratio[,-1], model="twoway")
```

##Bounds Plots

```{r}
a <- ggplot(bounds_df[which(bounds_df$res=="10kb"),], aes(x=cl, y=TotBounds, fill=cl))+
  geom_bar(stat="identity", position="dodge")+
  theme_minimal() +
  theme_bw()+
  xlab("") + ylab("") + ylim(0,27000) +
  scale_fill_discrete(name="Cell Line") +
  ggtitle("10 kb") +
  guides(fill=FALSE) +
  theme(axis.text.x = element_text(size=10),
     axis.text.y = element_text(size = 15),
     axis.title.x = element_text(size = 20),
     axis.title.y = element_text(size = 20),
     legend.text=element_text(size=15),
     legend.title=element_text(size=20),
     plot.title = element_text(size=20))


b <- ggplot(bounds_df[which(bounds_df$res=="25kb"),], aes(x=cl, y=TotBounds, fill=cl))+
  geom_bar(stat="identity", position="dodge")+
  theme_minimal() +
  theme_bw()+
  xlab("") + ylab("") + ylim(0,27000) +
  scale_fill_discrete(name="Cell Line") +
  ggtitle("25 kb") +
  guides(fill=FALSE) +
  theme(axis.text.x = element_text(size=10),
     axis.text.y = element_text(size = 15),
     axis.title.x = element_text(size = 20),
     axis.title.y = element_text(size = 20),
     legend.text=element_text(size=15),
     legend.title=element_text(size=20),
     plot.title = element_text(size=20))


c <- ggplot(bounds_df[which(bounds_df$res=="50kb"),], aes(x=cl, y=TotBounds, fill=cl))+
  geom_bar(stat="identity", position="dodge")+
  theme_minimal() +
  theme_bw()+
  xlab("") + ylab("") + ylim(0,27000) +
  scale_fill_discrete(name="Cell Line") +
  ggtitle("50 kb") +
  guides(fill=FALSE) +
  theme(axis.text.x = element_text(size=10),
     axis.text.y = element_text(size = 15),
     axis.title.x = element_text(size = 20),
     axis.title.y = element_text(size = 20),
     legend.text=element_text(size=15),
     legend.title=element_text(size=20),
     plot.title = element_text(size=20))


d <- ggplot(bounds_df[which(bounds_df$res=="100kb"),], aes(x=cl, y=TotBounds, fill=cl))+
  geom_bar(stat="identity", position="dodge")+
  theme_minimal() +
  theme_bw()+
  xlab("") + ylab("") + ylim(0,27000) +
  scale_fill_discrete(name="Cell Line") +
  ggtitle("100 kb") +
  guides(fill=FALSE) +
  theme(axis.text.x = element_text(size=10),
     axis.text.y = element_text(size = 15),
     axis.title.x = element_text(size = 20),
     axis.title.y = element_text(size = 20),
     legend.text=element_text(size=15),
     legend.title=element_text(size=20),
     plot.title = element_text(size=20))
  

figure <- ggarrange(a,b,c,d,
                    ncol=4,
                    nrow=1)
figure
annotate_figure(figure,
    #bottom = text_grob("Cell Line", color = "black", size = 20),
    left = text_grob("Number of TAD Boundary Regions", color = "black", rot = 90, size=20)
)

```

## IR Plots

```{r}
a <- ggplot(irtab[which(irtab$res=="10kb"),], aes(x=cl, y = ir, fill=cl, color=cl))  + 
 stat_boxplot(geom ='errorbar', width = 0.2) + 
 geom_boxplot() +
 theme_minimal() +
 theme_bw()+
 xlab("") + ylab("") + #ylim(5,21) +
 ggtitle("10 kb") +
 guides(fill=FALSE) +
 guides(color=FALSE) +
 theme(axis.text.x = element_text(size=15),
     axis.text.y = element_text(size = 15),
     axis.title.x = element_text(size = 20),
     axis.title.y = element_text(size = 20),
     legend.text=element_text(size=15),
     legend.title=element_text(size=20),
     plot.title = element_text(size=20))

b <- ggplot(irtab[which(irtab$res=="25kb"),], aes(x=cl, y = ir, fill=cl, color=cl))  + 
 stat_boxplot(geom ='errorbar', width = 0.2) + 
 geom_boxplot() +
 theme_minimal() +
 theme_bw()+
 xlab("") + ylab("") + #ylim(5,21) +
 ggtitle("25 kb") +
 guides(fill=FALSE) +
 guides(color=FALSE) +
 theme(axis.text.x = element_text(size=15),
     axis.text.y = element_text(size = 15),
     axis.title.x = element_text(size = 20),
     axis.title.y = element_text(size = 20),
     legend.text=element_text(size=15),
     legend.title=element_text(size=20),
     plot.title = element_text(size=20))

c <- ggplot(irtab[which(irtab$res=="50kb"),], aes(x=cl, y = ir, fill=cl, color=cl))  + 
 stat_boxplot(geom ='errorbar', width = 0.2) + 
 geom_boxplot() +
 theme_minimal() +
 theme_bw()+
 xlab("") + ylab("") + #ylim(5,21) +
 ggtitle("50 kb") +
 guides(fill=FALSE) +
 guides(color=FALSE) +
 theme(axis.text.x = element_text(size=15),
     axis.text.y = element_text(size = 15),
     axis.title.x = element_text(size = 20),
     axis.title.y = element_text(size = 20),
     legend.text=element_text(size=15),
     legend.title=element_text(size=20),
     plot.title = element_text(size=20))

d <- ggplot(irtab[which(irtab$res=="100kb"),], aes(x=cl, y = ir, fill=cl, color=cl))  + 
 stat_boxplot(geom ='errorbar', width = 0.2) + 
 geom_boxplot() +
 theme_minimal() +
 theme_bw()+
 xlab("") + ylab("") + #ylim(5,21) +
 ggtitle("100 kb") +
 guides(fill=FALSE) +
 guides(color=FALSE) +
 theme(axis.text.x = element_text(size=15),
     axis.text.y = element_text(size = 15),
     axis.title.x = element_text(size = 20),
     axis.title.y = element_text(size = 20),
     legend.text=element_text(size=15),
     legend.title=element_text(size=20),
     plot.title = element_text(size=20))

figure <- ggarrange(a,b,c,d,
                    ncol=4,
                    nrow=1)
figure
annotate_figure(figure,
    #bottom = text_grob("Cell Line", color = "black", size = 20),
    left = text_grob("Imbalance Ratio", color = "black", rot = 90, size=20)
)

```

